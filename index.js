"use strict";
/**
 * Created by user on 2018/5/15/015.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const git_diff_from_1 = require("git-diff-from");
const path = require("upath2");
const config_1 = require("./lib/config");
exports.loadConfig = config_1.default;
const Promise = require("bluebird");
exports.MODULE_NAME = 'node-novel-task';
function pathRelative(file) {
    let s = path.relative(process.cwd(), file);
    return s;
}
exports.pathRelative = pathRelative;
function globToFakeList(list) {
    let ret = {
        list: {},
        count: {
            main: 0,
            novel: 0,
            file: 0,
        },
    };
    ret.list = list.reduce(function (a, value) {
        let s = value.split(/[\\\/]/);
        if (s.length > 3) {
            let pathMain = s[0];
            let novelID = s[1];
            let basename = s[s.length - 1];
            let subpath = s.slice(2).join('/');
            if (!a[pathMain]) {
                ret.count.main++;
            }
            a[pathMain] = a[pathMain] || {};
            if (!a[pathMain][novelID]) {
                ret.count.novel++;
            }
            a[pathMain][novelID] = a[pathMain][novelID] || [];
            Object.assign(a[pathMain][novelID], {
                pathMain,
                novelID,
            });
            a[pathMain][novelID].push(Object.assign({
                path: value,
                pathMain,
                novelID,
                basename,
                subpath,
            }));
            ret.count.file++;
        }
        return a;
    }, {});
    console.log(ret.count);
    return ret;
}
exports.globToFakeList = globToFakeList;
function novelDiffFromLog(options) {
    let ls = git_diff_from_1.default(options.baseHash, 'origin/master', {
        cwd: options.novelRoot,
    });
    let ret = {
        novelRoot: options.novelRoot,
        baseHash: options.baseHash,
        list: {},
        range: {
            from: ls.from,
            to: ls.to,
        },
        count: {
            main: 0,
            novel: 0,
            file: 0,
        },
    };
    if (ls.length) {
        ret.list = ls.reduce(function (a, value) {
            let s = value.path.split(/[\\\/]/);
            if (s.length > 2) {
                let pathMain = s[0];
                let novelID = s[1];
                let basename = s[s.length - 1];
                let subpath = s.slice(2).join('/');
                if (!a[pathMain]) {
                    ret.count.main++;
                }
                a[pathMain] = a[pathMain] || {};
                if (!a[pathMain][novelID]) {
                    ret.count.novel++;
                }
                a[pathMain][novelID] = a[pathMain][novelID] || [];
                Object.assign(a[pathMain][novelID], {
                    pathMain,
                    novelID,
                });
                a[pathMain][novelID].push(Object.assign(value, {
                    pathMain,
                    novelID,
                    basename,
                    subpath,
                }));
                ret.count.file++;
            }
            return a;
        }, {});
    }
    return ret;
}
exports.novelDiffFromLog = novelDiffFromLog;
function runTask(data, setting, temp = {}) {
    return Promise.resolve(Promise
        .mapSeries(Object.keys(data.list), async function (main) {
        await Promise.mapSeries(Object.keys(data.list[main]), async function (novel) {
            if (setting.config.task.file) {
                await Promise.mapSeries(data.list[main][novel], async function (file) {
                    return setting.config.task.file(file, file.fullpath, temp);
                });
            }
            if (setting.config.task.novel) {
                await setting.config.task.novel(data.list[main][novel], novel, temp);
            }
        });
        if (setting.config.task.main) {
            await setting.config.task.main(data.list[main], main, temp);
        }
    }))
        .then(function (ls_map) {
        return { data, ls_map };
    })
        .tap(async function ({ data, ls_map }) {
        if (setting.config.task.before_end) {
            await setting.config.task.before_end(data, ls_map, temp);
        }
    });
}
exports.runTask = runTask;
exports.default = novelDiffFromLog;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgsaURBQTZEO0FBRTdELCtCQUFnQztBQUVoQyx5Q0FBc0M7QUFvTTdCLHFCQXBNRixnQkFBVSxDQW9NRTtBQW5NbkIsb0NBQXFDO0FBRXhCLFFBQUEsV0FBVyxHQUFHLGlCQUFpQixDQUFDO0FBRTdDLFNBQWdCLFlBQVksQ0FBQyxJQUFZO0lBRXhDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBRTNDLE9BQU8sQ0FBQyxDQUFDO0FBQ1YsQ0FBQztBQUxELG9DQUtDO0FBa0JELFNBQWdCLGNBQWMsQ0FBQyxJQUFjO0lBRTVDLElBQUksR0FBRyxHQUFHO1FBQ1QsSUFBSSxFQUFFLEVBRUw7UUFDRCxLQUFLLEVBQUU7WUFDTixJQUFJLEVBQUUsQ0FBQztZQUNQLEtBQUssRUFBRSxDQUFDO1lBQ1IsSUFBSSxFQUFFLENBQUM7U0FDUDtLQUNELENBQUM7SUFFRixHQUFHLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEVBQUUsS0FBSztRQUV4QyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRTlCLElBQUksQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQ2hCO1lBQ0MsSUFBSSxRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVuQixJQUFJLFFBQVEsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztZQUUvQixJQUFJLE9BQU8sR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFD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QUFJLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDekQ7SUFDRixDQUFDLENBQUMsQ0FDRDtBQUNILENBQUM7QUF4Q0QsMEJBd0NDO0FBRUQsa0JBQWUsZ0JBQWdCLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENyZWF0ZWQgYnkgdXNlciBvbiAyMDE4LzUvMTUvMDE1LlxuICovXG5cbmltcG9ydCBnaXREaWZmRnJvbSwgeyBJR2l0RGlmZkZyb21Sb3cgfSBmcm9tICdnaXQtZGlmZi1mcm9tJztcbmltcG9ydCBjb3NtaWNvbmZpZyA9IHJlcXVpcmUoJ2Nvc21pY29uZmlnJyk7XG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3VwYXRoMicpO1xuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMtZXh0cmEnKTtcbmltcG9ydCBsb2FkQ29uZmlnIGZyb20gJy4vbGliL2NvbmZpZyc7XG5pbXBvcnQgUHJvbWlzZSA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG5cbmV4cG9ydCBjb25zdCBNT0RVTEVfTkFNRSA9ICdub2RlLW5vdmVsLXRhc2snO1xuXG5leHBvcnQgZnVuY3Rpb24gcGF0aFJlbGF0aXZlKGZpbGU6IHN0cmluZylcbntcblx0bGV0IHMgPSBwYXRoLnJlbGF0aXZlKHByb2Nlc3MuY3dkKCksIGZpbGUpO1xuXG5cdHJldHVybiBzO1xufVxuXG5leHBvcnQgdHlwZSBJTGlzdEZpbGVSb3cgPSBJR2l0RGlmZkZyb21Sb3cgJiB7XG5cdHBhdGhNYWluOiBzdHJpbmcsXG5cdG5vdmVsSUQ6IHN0cmluZyxcblx0YmFzZW5hbWU6IHN0cmluZyxcblx0c3VicGF0aDogc3RyaW5nLFxufVxuXG5leHBvcnQgdHlwZSBJTGlzdE5vdmVsUm93ID0gSUxpc3RGaWxlUm93W10gJiB7XG5cdHBhdGhNYWluOiBzdHJpbmcsXG5cdG5vdmVsSUQ6IHN0cmluZyxcbn1cblxuZXhwb3J0IHR5cGUgSUxpc3RNYWluUm93ID0ge1xuXHRba2V5OiBzdHJpbmddOiBJTGlzdE5vdmVsUm93LFxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2xvYlRvRmFrZUxpc3QobGlzdDogc3RyaW5nW10pXG57XG5cdGxldCByZXQgPSB7XG5cdFx0bGlzdDoge30gYXMge1xuXHRcdFx0W2tleTogc3RyaW5nXTogSUxpc3RNYWluUm93LFxuXHRcdH0sXG5cdFx0Y291bnQ6IHtcblx0XHRcdG1haW46IDAsXG5cdFx0XHRub3ZlbDogMCxcblx0XHRcdGZpbGU6IDAsXG5cdFx0fSxcblx0fTtcblxuXHRyZXQubGlzdCA9IGxpc3QucmVkdWNlKGZ1bmN0aW9uIChhLCB2YWx1ZSlcblx0e1xuXHRcdGxldCBzID0gdmFsdWUuc3BsaXQoL1tcXFxcXFwvXS8pO1xuXG5cdFx0aWYgKHMubGVuZ3RoID4gMylcblx0XHR7XG5cdFx0XHRsZXQgcGF0aE1haW4gPSBzWzBdO1xuXHRcdFx0bGV0IG5vdmVsSUQgPSBzWzFdO1xuXG5cdFx0XHRsZXQgYmFzZW5hbWUgPSBzW3MubGVuZ3RoIC0gMV07XG5cblx0XHRcdGxldCBzdWJwYXRoID0gcy5zbGljZSgyKS5qb2luKCcvJyk7XG5cblx0XHRcdGlmICghYVtwYXRoTWFpbl0pXG5cdFx0XHR7XG5cdFx0XHRcdHJldC5jb3VudC5tYWluKys7XG5cdFx0XHR9XG5cblx0XHRcdGFbcGF0aE1haW5dID0gYVtwYXRoTWFpbl0gfHwge307XG5cblx0XHRcdGlmICghYVtwYXRoTWFpbl1bbm92ZWxJRF0pXG5cdFx0XHR7XG5cdFx0XHRcdHJldC5jb3VudC5ub3ZlbCsrO1xuXHRcdFx0fVxuXG5cdFx0XHRhW3BhdGhNYWluXVtub3ZlbElEXSA9IGFbcGF0aE1haW5dW25vdmVsSURdIHx8IFtdO1xuXG5cdFx0XHRPYmplY3QuYXNzaWduKGFbcGF0aE1haW5dW25vdmVsSURdLCB7XG5cdFx0XHRcdHBhdGhNYWluLFxuXHRcdFx0XHRub3ZlbElELFxuXHRcdFx0fSk7XG5cblx0XHRcdGFbcGF0aE1haW5dW25vdmVsSURdLnB1c2goT2JqZWN0LmFzc2lnbih7XG5cblx0XHRcdFx0cGF0aDogdmFsdWUsXG5cblx0XHRcdFx0cGF0aE1haW4sXG5cdFx0XHRcdG5vdmVsSUQsXG5cdFx0XHRcdGJhc2VuYW1lLFxuXHRcdFx0XHRzdWJwYXRoLFxuXHRcdFx0fSkpO1xuXG5cdFx0XHRyZXQuY291bnQuZmlsZSsrO1xuXHRcdH1cblxuXHRcdHJldHVybiBhO1xuXHR9LCB7fSk7XG5cblx0Y29uc29sZS5sb2cocmV0LmNvdW50KTtcblxuXHRyZXR1cm4gcmV0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbm92ZWxEaWZmRnJvbUxvZyhvcHRpb25zOiB7XG5cdG5vdmVsUm9vdDogc3RyaW5nLFxuXHRiYXNlSGFzaD86IG51bWJlciB8IHN0cmluZyxcbn0pXG57XG5cdGxldCBscyA9IGdpdERpZmZGcm9tKG9wdGlvbnMuYmFzZUhhc2gsICdvcmlnaW4vbWFzdGVyJywge1xuXHRcdGN3ZDogb3B0aW9ucy5ub3ZlbFJvb3QsXG5cdH0pO1xuXG5cdGxldCByZXQgPSB7XG5cdFx0bm92ZWxSb290OiBvcHRpb25zLm5vdmVsUm9vdCxcblx0XHRiYXNlSGFzaDogb3B0aW9ucy5iYXNlSGFzaCxcblx0XHRsaXN0OiB7fSBhcyB7XG5cdFx0XHRba2V5OiBzdHJpbmddOiBJTGlzdE1haW5Sb3csXG5cdFx0fSxcblxuXHRcdHJhbmdlOiB7XG5cdFx0XHRmcm9tOiBscy5mcm9tLFxuXHRcdFx0dG86IGxzLnRvLFxuXHRcdH0sXG5cblx0XHRjb3VudDoge1xuXHRcdFx0bWFpbjogMCxcblx0XHRcdG5vdmVsOiAwLFxuXHRcdFx0ZmlsZTogMCxcblx0XHR9LFxuXHR9O1xuXG5cdGlmIChscy5sZW5ndGgpXG5cdHtcblx0XHRyZXQubGlzdCA9IGxzLnJlZHVjZShmdW5jdGlvbiAoYSwgdmFsdWUpXG5cdFx0e1xuXHRcdFx0bGV0IHMgPSB2YWx1ZS5wYXRoLnNwbGl0KC9bXFxcXFxcL10vKTtcblxuXHRcdFx0aWYgKHMubGVuZ3RoID4gMilcblx0XHRcdHtcblx0XHRcdFx0bGV0IHBhdGhNYWluID0gc1swXTtcblx0XHRcdFx0bGV0IG5vdmVsSUQgPSBzWzFdO1xuXG5cdFx0XHRcdGxldCBiYXNlbmFtZSA9IHNbcy5sZW5ndGggLSAxXTtcblxuXHRcdFx0XHRsZXQgc3VicGF0aCA9IHMuc2xpY2UoMikuam9pbignLycpO1xuXG5cdFx0XHRcdGlmICghYVtwYXRoTWFpbl0pXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRyZXQuY291bnQubWFpbisrO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0YVtwYXRoTWFpbl0gPSBhW3BhdGhNYWluXSB8fCB7fTtcblxuXHRcdFx0XHRpZiAoIWFbcGF0aE1haW5dW25vdmVsSURdKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cmV0LmNvdW50Lm5vdmVsKys7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRhW3BhdGhNYWluXVtub3ZlbElEXSA9IGFbcGF0aE1haW5dW25vdmVsSURdIHx8IFtdO1xuXG5cdFx0XHRcdE9iamVjdC5hc3NpZ24oYVtwYXRoTWFpbl1bbm92ZWxJRF0sIHtcblx0XHRcdFx0XHRwYXRoTWFpbixcblx0XHRcdFx0XHRub3ZlbElELFxuXHRcdFx0XHR9KTtcblxuXHRcdFx0XHRhW3BhdGhNYWluXVtub3ZlbElEXS5wdXNoKE9iamVjdC5hc3NpZ24odmFsdWUsIHtcblx0XHRcdFx0XHRwYXRoTWFpbixcblx0XHRcdFx0XHRub3ZlbElELFxuXHRcdFx0XHRcdGJhc2VuYW1lLFxuXHRcdFx0XHRcdHN1YnBhdGgsXG5cdFx0XHRcdH0pKTtcblxuXHRcdFx0XHRyZXQuY291bnQuZmlsZSsrO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gYTtcblx0XHR9LCB7fSk7XG5cdH1cblxuXHRyZXR1cm4gcmV0O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElUZW1wXG57XG5cdGluaXQ/OiBib29sZWFuLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElDb25maWdcbntcblx0Y3dkOiBzdHJpbmcsXG5cdHRhc2s/OiB7XG5cdFx0bWFpbj8oZGF0YTogSUxpc3RNYWluUm93LCBuYW1lOiBzdHJpbmcsIHRlbXA/OiBJVGVtcCk7XG5cdFx0bm92ZWw/KGRhdGE6IElMaXN0Tm92ZWxSb3csIG5hbWU6IHN0cmluZywgdGVtcD86IElUZW1wKTtcblx0XHRmaWxlPyhkYXRhOiBJTGlzdEZpbGVSb3csIGZpbGU6IHN0cmluZywgdGVtcD86IElUZW1wKTtcblx0XHRiZWZvcmVfZW5kPyhkYXRhOiBSZXR1cm5UeXBlPHR5cGVvZiBub3ZlbERpZmZGcm9tTG9nPiwgbHNfbWFwOiBhbnlbXSwgdGVtcD86IElUZW1wKTtcblx0fSxcblx0ZGVidWc/OiB7XG5cdFx0bm9fcHVzaD86IGJvb2xlYW4sXG5cdFx0aW5pdD86IGJvb2xlYW4sXG5cdFx0bGFzdD86IHN0cmluZyB8IG51bWJlcixcblx0fSxcblx0bm9jYWNoZT86IGJvb2xlYW4sXG5cdGRpc2FibGVJbml0PzogYm9vbGVhbixcbn1cblxuZXhwb3J0IHsgbG9hZENvbmZpZyB9XG5cbmV4cG9ydCBmdW5jdGlvbiBydW5UYXNrKGRhdGE6IFJldHVyblR5cGU8dHlwZW9mIG5vdmVsRGlmZkZyb21Mb2c+LCBzZXR0aW5nOiBSZXR1cm5UeXBlPHR5cGVvZiBsb2FkQ29uZmlnPiAmIHtcblx0Y29uZmlnOiBJQ29uZmlnLFxufSwgdGVtcDogSVRlbXAgPSB7fSlcbntcblx0cmV0dXJuIFByb21pc2UucmVzb2x2ZShQcm9taXNlXG5cdFx0Lm1hcFNlcmllcyhPYmplY3Qua2V5cyhkYXRhLmxpc3QpLCBhc3luYyBmdW5jdGlvbiAobWFpbilcblx0XHR7XG5cdFx0XHRhd2FpdCBQcm9taXNlLm1hcFNlcmllcyhPYmplY3Qua2V5cyhkYXRhLmxpc3RbbWFpbl0pLCBhc3luYyBmdW5jdGlvbiAobm92ZWwpXG5cdFx0XHR7XG5cdFx0XHRcdGlmIChzZXR0aW5nLmNvbmZpZy50YXNrLmZpbGUpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRhd2FpdCBQcm9taXNlLm1hcFNlcmllcyhkYXRhLmxpc3RbbWFpbl1bbm92ZWxdLCBhc3luYyBmdW5jdGlvbiAoZmlsZSlcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRyZXR1cm4gc2V0dGluZy5jb25maWcudGFzay5maWxlKGZpbGUsIGZpbGUuZnVsbHBhdGgsIHRlbXApO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0aWYgKHNldHRpbmcuY29uZmlnLnRhc2subm92ZWwpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRhd2FpdCBzZXR0aW5nLmNvbmZpZy50YXNrLm5vdmVsKGRhdGEubGlzdFttYWluXVtub3ZlbF0sIG5vdmVsLCB0ZW1wKTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cblx0XHRcdGlmIChzZXR0aW5nLmNvbmZpZy50YXNrLm1haW4pXG5cdFx0XHR7XG5cdFx0XHRcdGF3YWl0IHNldHRpbmcuY29uZmlnLnRhc2subWFpbihkYXRhLmxpc3RbbWFpbl0gYXMgSUxpc3RNYWluUm93LCBtYWluLCB0ZW1wKTtcblx0XHRcdH1cblx0XHR9KSlcblx0XHQudGhlbihmdW5jdGlvbiAobHNfbWFwKVxuXHRcdHtcblx0XHRcdHJldHVybiB7IGRhdGEsIGxzX21hcCB9O1xuXHRcdH0pXG5cdFx0LnRhcChhc3luYyBmdW5jdGlvbiAoeyBkYXRhLCBsc19tYXAgfSlcblx0XHR7XG5cdFx0XHRpZiAoc2V0dGluZy5jb25maWcudGFzay5iZWZvcmVfZW5kKVxuXHRcdFx0e1xuXHRcdFx0XHRhd2FpdCBzZXR0aW5nLmNvbmZpZy50YXNrLmJlZm9yZV9lbmQoZGF0YSwgbHNfbWFwLCB0ZW1wKTtcblx0XHRcdH1cblx0XHR9KVxuXHRcdDtcbn1cblxuZXhwb3J0IGRlZmF1bHQgbm92ZWxEaWZmRnJvbUxvZ1xuIl19